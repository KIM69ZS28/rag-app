<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG Demo UI (Cognito Hosted UI + PKCE)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 980px;
      margin: 36px auto;
      padding: 0 16px;
      background: #fafafa;
      color: #111;
    }
    h1 { font-size: 22px; margin-bottom: 6px; }
    .sub { color: #444; margin-top: 0; }
    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 14px 14px 10px;
      margin-top: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #111;
      color: #fff;
      font-weight: 600;
    }
    button.secondary {
      background: #fff;
      color: #111;
    }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    textarea, input {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    label { display: block; font-weight: 700; margin-top: 10px; }
    pre {
      background: #0b0b0b;
      color: #d9ffd9;
      padding: 12px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .muted { color: #666; font-size: 12px; }
    .ok { color: #0b7a0b; font-weight: 700; }
    .ng { color: #b00020; font-weight: 700; }
    .error {
      color: #b00020;
      white-space: pre-wrap;
      background: #fff0f3;
      border: 1px solid #ffd0da;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
    }
    code.inline {
      background: #f2f2f2;
      padding: 2px 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<h1>RAG Q&A Demo UI</h1>
<p class="sub">Cognito Hosted UI（認可コード + PKCE）でログイン → JWT取得 → <code class="inline">/ask</code> 実行</p>

<div class="card">
  <h2 style="margin:0 0 8px;">0) 設定（ここだけ確認）</h2>
  <p class="muted" style="margin:0;">
    このHTMLは <b>http://localhost:8000/test.html</b> 前提です。Cognito側の「コールバックURL」に同じURLを登録してください。
  </p>
</div>

<div class="card">
  <h2 style="margin:0 0 8px;">1) ログイン（Hosted UI）</h2>
  <div class="row">
    <button id="btnLogin" onclick="startLogin()">ログイン</button>
    <button class="secondary" id="btnLogout" onclick="logout()" disabled>ログアウト</button>
    <button class="secondary" onclick="clearLocal()">ローカル状態クリア</button>
  </div>
  <p id="authStatus" class="muted" style="margin:10px 0 0;">未ログイン</p>
  <div id="authError" class="error" style="display:none;"></div>

  <details style="margin-top:10px;">
    <summary class="muted">JWT内容（デコード表示）</summary>
    <pre id="jwtDecoded">(ログイン後に表示)</pre>
  </details>
</div>

<div class="card">
  <h2 style="margin:0 0 8px;">2) 質問 → /ask</h2>
  <label>Question</label>
  <textarea id="question" rows="3">勤怠締め後の修正は誰ができますか？監査上の注意点も教えてください。</textarea>

  <div class="row" style="margin-top:10px;">
    <button id="btnAsk" onclick="ask()" disabled>/ask を叩く</button>
    <button class="secondary" onclick="copyCurl()" id="btnCurl" disabled>curl例をコピー</button>
  </div>

  <p class="muted" style="margin-top:8px;">
    ※ API Gateway 側で <code class="inline">Authorization</code> ヘッダのCORS許可が必要です（かずしさんは既に設定OK）。
  </p>
</div>

<div class="card">
  <h2 style="margin:0 0 8px;">3) レスポンス</h2>
  <pre id="response">(ここに表示)</pre>
  <div id="apiError" class="error" style="display:none;"></div>
</div>

<script>
/**
 * ==========================
 * TODO: 環境に合わせて変更（3か所だけ）
 * ==========================
 */
const COGNITO_DOMAIN = "https://ap-northeast-1sdomqb5lg.auth.ap-northeast-1.amazoncognito.com";
const CLIENT_ID      = "ookegapqc2u2vkgu5ubgv2uua";
const API_URL        = "https://ui2eu8z8bb.execute-api.ap-northeast-1.amazonaws.com/prod/ask";

/**
 * このHTML自体のURL（= CognitoのコールバックURLに登録するURL）
 * http.serverで開く前提のため固定でOK
 */
const REDIRECT_URI = "http://localhost:8000/test.html";

/**
 * 取得したトークンを保持（sessionStorage：タブを閉じると消える）
 * - API GatewayのJWT Authorizerは「IDトークン」「アクセストークン」どちらでも通る設定にしているケースが多いですが、
 *   まずはIDトークンで統一します（openid必須）。
 */
const STORAGE_KEY = "rag_demo_tokens_v1";

/* ========= ここから下は基本触らない ========= */

function $(id) { return document.getElementById(id); }

function showError(el, msg) {
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}

function setStatus(text, ok=false) {
  $("authStatus").innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="muted">${text}</span>`;
}

function setAskEnabled(enabled) {
  $("btnAsk").disabled = !enabled;
  $("btnCurl").disabled = !enabled;
  $("btnLogout").disabled = !enabled;
}

function clearLocal() {
  sessionStorage.removeItem(STORAGE_KEY);
  sessionStorage.removeItem("pkce_verifier");
  // URLの code 等を掃除
  const url = new URL(window.location.href);
  url.searchParams.delete("code");
  url.searchParams.delete("state");
  url.searchParams.delete("error");
  url.searchParams.delete("error_description");
  history.replaceState({}, "", url.toString());

  $("jwtDecoded").textContent = "(ログイン後に表示)";
  $("response").textContent = "(ここに表示)";
  showError($("authError"), "");
  showError($("apiError"), "");
  setStatus("未ログイン");
  setAskEnabled(false);
}

/** base64url decode */
function b64urlDecode(str) {
  str = str.replace(/-/g, "+").replace(/_/g, "/");
  const pad = str.length % 4;
  if (pad) str += "=".repeat(4 - pad);
  const decoded = atob(str);
  // UTF-8対応
  const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}

function decodeJwt(jwt) {
  const parts = jwt.split(".");
  if (parts.length !== 3) return { error: "JWTの形式が不正です（3セグメントではありません）" };
  try {
    return {
      header: JSON.parse(b64urlDecode(parts[0])),
      payload: JSON.parse(b64urlDecode(parts[1])),
      signature: "(省略)"
    };
  } catch (e) {
    return { error: "JWTのデコードに失敗しました", detail: String(e) };
  }
}

/** PKCE helper */
async function sha256(plain) {
  const enc = new TextEncoder().encode(plain);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  return new Uint8Array(digest);
}

function base64urlEncode(bytes) {
  let binary = "";
  bytes.forEach(b => binary += String.fromCharCode(b));
  return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

function randomString(len=64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const bytes = crypto.getRandomValues(new Uint8Array(len));
  return Array.from(bytes, b => chars[b % chars.length]).join("");
}

async function pkceChallengeFromVerifier(verifier) {
  const hashed = await sha256(verifier);
  return base64urlEncode(hashed);
}

/**
 * Hosted UIへ遷移（認可コード+PKCE）
 */
async function startLogin() {
  showError($("authError"), "");
  setStatus("Hosted UIへ遷移します…");

  const state = randomString(16);
  const verifier = randomString(64);
  const challenge = await pkceChallengeFromVerifier(verifier);

  sessionStorage.setItem("pkce_verifier", verifier);
  sessionStorage.setItem("pkce_state", state);

  const authorizeUrl = new URL(`${COGNITO_DOMAIN}/oauth2/authorize`);
  authorizeUrl.searchParams.set("response_type", "code");
  authorizeUrl.searchParams.set("client_id", CLIENT_ID);
  authorizeUrl.searchParams.set("redirect_uri", REDIRECT_URI);
  authorizeUrl.searchParams.set("scope", "openid email"); // 必要最低限: openid（id_tokenが欲しいため）
  authorizeUrl.searchParams.set("state", state);
  authorizeUrl.searchParams.set("code_challenge", challenge);
  authorizeUrl.searchParams.set("code_challenge_method", "S256");

  window.location.href = authorizeUrl.toString();
}

/**
 * code -> token 交換
 */
async function exchangeCodeForToken(code) {
  const verifier = sessionStorage.getItem("pkce_verifier") || "";
  if (!verifier) throw new Error("PKCE verifier が見つかりません（再度ログインしてください）");

  const params = new URLSearchParams();
  params.set("grant_type", "authorization_code");
  params.set("client_id", CLIENT_ID);
  params.set("code", code);
  params.set("redirect_uri", REDIRECT_URI);
  params.set("code_verifier", verifier);

  const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: params.toString(),
  });

  const raw = await res.text();
  let data;
  try { data = JSON.parse(raw); } catch { data = { raw }; }

  if (!res.ok) {
    throw new Error(`token exchange failed (${res.status})\n` + JSON.stringify(data, null, 2));
  }

  // data: { id_token, access_token, refresh_token, token_type, expires_in }
  sessionStorage.setItem(STORAGE_KEY, JSON.stringify({
    id_token: data.id_token || "",
    access_token: data.access_token || "",
    refresh_token: data.refresh_token || "",
    expires_in: data.expires_in || 0,
    token_type: data.token_type || "Bearer",
    obtained_at: Date.now()
  }));

  // 使い終わったらURLからcodeを消す（気持ちよくする）
  const url = new URL(window.location.href);
  url.searchParams.delete("code");
  url.searchParams.delete("state");
  history.replaceState({}, "", url.toString());

  return data;
}

/**
 * ログアウト（Hosted UIのlogoutへ）
 */
function logout() {
  clearLocal();
  const logoutUrl = new URL(`${COGNITO_DOMAIN}/logout`);
  logoutUrl.searchParams.set("client_id", CLIENT_ID);
  logoutUrl.searchParams.set("logout_uri", REDIRECT_URI);
  window.location.href = logoutUrl.toString();
}

/**
 * 画面ロード時：codeがあれば交換、なければ保存済みトークンで復元
 */
async function init() {
  showError($("authError"), "");
  showError($("apiError"), "");

  const url = new URL(window.location.href);

  // Cognitoからのエラー返却（Hosted UIで弾かれた場合）
  const oauthErr = url.searchParams.get("error");
  const oauthErrDesc = url.searchParams.get("error_description");
  if (oauthErr) {
    setStatus("未ログイン");
    setAskEnabled(false);
    showError($("authError"), `Hosted UI error: ${oauthErr}\n${oauthErrDesc || ""}`);
    return;
  }

  const code = url.searchParams.get("code");
  const state = url.searchParams.get("state");
  const savedState = sessionStorage.getItem("pkce_state");

  if (code) {
    // stateチェック（CSRF対策）
    if (!state || !savedState || state !== savedState) {
      setStatus("未ログイン");
      setAskEnabled(false);
      showError($("authError"), "state不一致（セキュリティ上ブロックしました）。もう一度ログインしてください。");
      return;
    }

    setStatus("トークン取得中…");
    try {
      const t = await exchangeCodeForToken(code);
      setStatus("ログイン成功（トークン取得済み）", true);
      setAskEnabled(true);

      // デコード表示（IDトークン優先）
      const jwt = t.id_token || t.access_token || "";
      const decoded = decodeJwt(jwt);
      $("jwtDecoded").textContent = JSON.stringify(decoded, null, 2);

    } catch (e) {
      setStatus("未ログイン");
      setAskEnabled(false);
      showError($("authError"), String(e));
    }
    return;
  }

  // codeがない場合：保存済みトークンがあれば復元
  const saved = sessionStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const t = JSON.parse(saved);
      const jwt = t.id_token || t.access_token || "";
      if (jwt) {
        setStatus("ログイン済み（保存トークンを復元）", true);
        setAskEnabled(true);
        $("jwtDecoded").textContent = JSON.stringify(decodeJwt(jwt), null, 2);
        return;
      }
    } catch {}
  }

  setStatus("未ログイン");
  setAskEnabled(false);
}

async function ask() {
  $("response").textContent = "";
  showError($("apiError"), "");

  const saved = sessionStorage.getItem(STORAGE_KEY);
  if (!saved) {
    showError($("apiError"), "先にログインしてください（JWT未取得）");
    return;
  }

  const t = JSON.parse(saved);

  // どのトークンをAuthorizationに載せるか：
  // - まずはIDトークン（READMEで既にIdTokenで動かしているため）
  // - もし Authorizer 側が access_token 前提なら、ここを access_token に切り替えてください
  const token = t.id_token; // ←必要なら t.access_token に変更

  if (!token) {
    showError($("apiError"), "IDトークンがありません。openidスコープが有効か確認してください。");
    return;
  }

  const question = $("question").value.trim();
  if (!question) {
    showError($("apiError"), "質問が空です。");
    return;
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ question })
    });

    const text = await res.text();
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}\n` + text);
    }

    // JSONとして整形表示
    const json = JSON.parse(text);
    $("response").textContent = JSON.stringify(json, null, 2);

  } catch (e) {
    showError($("apiError"), String(e));
  }
}

function copyCurl() {
  const saved = sessionStorage.getItem(STORAGE_KEY);
  if (!saved) return;

  const t = JSON.parse(saved);
  const token = t.id_token || "";
  const q = $("question").value.trim() || "勤怠締め後の修正は誰ができますか？";

  const cmd =
`curl -i -X POST "${API_URL}" \\
  -H "Content-Type: application/json" \\
  -H "Authorization: Bearer ${token}" \\
  -d '${JSON.stringify({ question: q })}'`;

  navigator.clipboard.writeText(cmd).then(() => {
    $("response").textContent = "(curl例をコピーしました)\n\n" + cmd;
  }).catch(() => {
    $("response").textContent = "(クリップボードにコピーできませんでした)\n\n" + cmd;
  });
}

window.addEventListener("load", init);
</script>

</body>
</html>
